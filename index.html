<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Print Editor - Fabric.js</title>
  <style>
    body { font-family: Arial, sans-serif; margin:12px; background:#f7f7f7; }
    .toolbar { margin-bottom: 10px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .canvas-wrap { background: #ddd; padding: 12px; border-radius: 8px; display:flex; justify-content:center; }
    canvas { border: 1px solid #999; background: #fff; }
    label { font-size: 14px; }
    .small { font-size: 12px; color:#555; }
    input[type=file], select, input[type=range], button { padding:6px 8px; border-radius:6px; border:1px solid #bbb; }
    button { cursor:pointer; background:white; }
  </style>
</head>
<body>
  <h3>Print Editor — Upload → Edit → Download (PNG @ 300 DPI)</h3>

  <div class="toolbar">
    <label>Template:
      <select id="templateSelect">
        <option value="71x31">71 cm × 31 cm</option>
        <option value="81x31">81 cm × 31 cm</option>
        <option value="91x41">91 cm × 41 cm</option>
      </select>
    </label>

    <label>Upload image:
      <input type="file" id="fileInput" accept="image/*">
    </label>

    <label>Zoom:
      <input id="zoomSlider" type="range" min="50" max="300" value="100">
    </label>

    <button id="fitBtn">Fit Template</button>
    <button id="centerBtn">Center Image</button>
    <button id="toggleBleedBtn">Toggle Bleed Guide</button>
    <button id="downloadBtn">Download PNG (300 DPI)</button>
  </div>

  <div class="small">
    Tip: Use corner handles to scale uniformly, side handles to stretch. Bleed guide shows safe printing area.
  </div>

  <div class="canvas-wrap" id="canvasWrap">
    <canvas id="c"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const CM_TO_IN = 0.393700787; // cm → inches
      const DPI = 300;              // target export DPI
      const PREVIEW_WIDTH = Math.min(1200, window.innerWidth-80);

      const TEMPLATES = {
        '71x31': { w_cm:71, h_cm:31 },
        '81x31': { w_cm:81, h_cm:31 },
        '91x41': { w_cm:91, h_cm:41 }
      };

      const BLEED_CM = 0.5; // 0.5 cm bleed
      let bleedVisible = true;

      const canvas = new fabric.Canvas('c', { preserveObjectStacking:true, selection:true, backgroundColor:'#fff' });

      // ---------- Canvas setup ----------
      function setCanvasSize(templateKey){
        const tpl = TEMPLATES[templateKey];
        const aspect = tpl.w_cm / tpl.h_cm;
        const width = PREVIEW_WIDTH;
        const height = Math.round(width / aspect);
        canvas.setWidth(width);
        canvas.setHeight(height);
        document.getElementById('canvasWrap').style.height = (height+24)+'px';
      }

      let templateRect = null;
      let bleedRect = null;

      function drawTemplate(templateKey){
        // remove previous
        if(templateRect) canvas.remove(templateRect);
        if(bleedRect) canvas.remove(bleedRect);

        const tpl = TEMPLATES[templateKey];
        const w = canvas.getWidth();
        const h = canvas.getHeight();

        // Template outline (main boundary)
        templateRect = new fabric.Rect({
          left:0, top:0, width:w, height:h,
          fill:'rgba(0,0,0,0)', stroke:'#FF6B00', strokeWidth:2,
          selectable:false, evented:false
        });
        canvas.add(templateRect);
        templateRect.sendToBack();

        // Bleed area (inner rectangle)
        if(bleedVisible){
          const bleedPx = BLEED_CM / tpl.w_cm * w; // approximate
          bleedRect = new fabric.Rect({
            left:bleedPx, top:bleedPx,
            width:w-2*bleedPx, height:h-2*bleedPx,
            fill:'rgba(0,0,0,0)',
            stroke:'#00AA00',
            strokeWidth:1,
            selectable:false, evented:false
          });
          canvas.add(bleedRect);
          bleedRect.sendToBack();
        }

        canvas.requestRenderAll();
      }

      // ---------- File Upload ----------
      document.getElementById('fileInput').addEventListener('change', function(e){
        const file = e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(event){
          const dataUrl = event.target.result;

          fabric.Image.fromURL(dataUrl, function(img){
            img.set({
              left: canvas.getWidth()/2,
              top: canvas.getHeight()/2,
              originX:'center', originY:'center',
              selectable:true,
              hasRotatingPoint:true,
              lockScalingFlip:false,
              lockUniScaling:false // allow stretch
            });
            const scale = Math.min(canvas.getWidth()/img.width, canvas.getHeight()/img.height);
            img.scale(scale*0.9);
            canvas.add(img);
            canvas.setActiveObject(img);
            canvas.requestRenderAll();
          }, { crossOrigin:'anonymous' });
        };
        reader.readAsDataURL(file);
      });

      // ---------- Zoom ----------
      document.getElementById('zoomSlider').addEventListener('input', function(){
        const zoom = parseInt(this.value)/100;
        canvas.setZoom(zoom);
        canvas.requestRenderAll();
      });

      // ---------- Fit / Center ----------
      document.getElementById('fitBtn').addEventListener('click', function(){
        const obj = canvas.getActiveObject();
        if(!obj) return alert('Select an image first.');
        const w = canvas.getWidth();
        const h = canvas.getHeight();
        obj.scaleToWidth(w*0.9);
        obj.scaleToHeight(h*0.9);
        obj.set({ left:w/2, top:h/2, originX:'center', originY:'center' });
        canvas.requestRenderAll();
      });

      document.getElementById('centerBtn').addEventListener('click', function(){
        const obj = canvas.getActiveObject();
        if(!obj) return alert('Select an image first.');
        obj.set({ left: canvas.getWidth()/2, top: canvas.getHeight()/2, originX:'center', originY:'center' });
        canvas.requestRenderAll();
      });

      // ---------- Toggle Bleed ----------
      document.getElementById('toggleBleedBtn').addEventListener('click', function(){
        bleedVisible = !bleedVisible;
        drawTemplate(document.getElementById('templateSelect').value);
      });

      // ---------- Template change ----------
      const tplSelect = document.getElementById('templateSelect');
      tplSelect.addEventListener('change', function(){
        setCanvasSize(this.value);
        drawTemplate(this.value);
      });

      setCanvasSize(tplSelect.value);
      drawTemplate(tplSelect.value);

      // ---------- Download PNG ----------
      document.getElementById('downloadBtn').addEventListener('click', function(){
        const tpl = TEMPLATES[tplSelect.value];
        const w_in = tpl.w_cm*CM_TO_IN;
        const h_in = tpl.h_cm*CM_TO_IN;
        const targetW = Math.round(w_in*DPI);
        const targetH = Math.round(h_in*DPI);

        const multiplier = Math.min(targetW/canvas.getWidth(), targetH/canvas.getHeight());

        canvas.discardActiveObject();
        canvas.renderAll();

        const dataURL = canvas.toDataURL({ format:'png', multiplier:multiplier, quality:1.0 });
        const link = document.createElement('a');
        link.href = dataURL;
        link.download = `design_${tpl.w_cm}x${tpl.h_cm}_${DPI}dpi.png`;
        document.body.appendChild(link);
        link.click();
        link.remove();
      });

      // ---------- Fabric object defaults ----------
      canvas.on('object:added', function(e){
        if(e.target && e.target.type==='image'){
          e.target.set({ lockUniScaling:false, lockScalingFlip:false });
        }
      });

      canvas.on('object:added', canvas.on('object:modified', function(){
        if(templateRect) templateRect.sendToBack();
        if(bleedRect) bleedRect.sendToBack();
      }));

      // ---------- Window resize ----------
      window.addEventListener('resize', function(){
        const prev = tplSelect.value;
        setCanvasSize(prev);
        drawTemplate(prev);
      });

      window._fabricCanvas = canvas; // expose for debugging
    });
  </script>
</body>
</html>
